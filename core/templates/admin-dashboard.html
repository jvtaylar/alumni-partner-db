{% extends "base.html" %}

{% block title %}Admin Dashboard - Alumni Partner Connect{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4"><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-users"></i> Total Alumni</h5>
                    <h2 class="mb-0" id="totalAlumni">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-building"></i> Total Partners</h5>
                    <h2 class="mb-0" id="totalPartners">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-handshake"></i> Total Engagements</h5>
                    <h2 class="mb-0" id="totalEngagements">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-user"></i> Total Users</h5>
                    <h2 class="mb-0" id="totalUsers">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for different admin sections -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="bulk-ops-tab" data-bs-toggle="tab" data-bs-target="#bulk-ops" type="button" role="tab">
                <i class="fas fa-tasks"></i> Bulk Operations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="audit-trail-tab" data-bs-toggle="tab" data-bs-target="#audit-trail" type="button" role="tab">
                <i class="fas fa-history"></i> Audit Trail
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="user-mgmt-tab" data-bs-toggle="tab" data-bs-target="#user-mgmt" type="button" role="tab">
                <i class="fas fa-users-cog"></i> User Management
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="exports-tab" data-bs-toggle="tab" data-bs-target="#exports" type="button" role="tab">
                <i class="fas fa-file-export"></i> Data Exports
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="adminTabContent">
        
        <!-- Bulk Operations Tab -->
        <div class="tab-pane fade show active" id="bulk-ops" role="tabpanel">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-user-graduate"></i> Alumni Bulk Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Select Alumni Status</label>
                                <select class="form-select" id="alumniStatusFilter">
                                    <option value="">All Alumni</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="lost_contact">Lost Contact</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Select Action</label>
                                <select class="form-select" id="alumniAction">
                                    <option value="">Choose action...</option>
                                    <option value="mark_active">Mark as Active</option>
                                    <option value="mark_inactive">Mark as Inactive</option>
                                    <option value="mark_lost">Mark as Lost Contact</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="applyAlumniBulkAction()">
                                <i class="fas fa-check"></i> Apply Action
                            </button>
                            <p class="text-muted mt-2 mb-0" id="alumniCount">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-building"></i> Partner Bulk Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Select Partner Level</label>
                                <select class="form-select" id="partnerLevelFilter">
                                    <option value="">All Partners</option>
                                    <option value="gold">Gold</option>
                                    <option value="silver">Silver</option>
                                    <option value="bronze">Bronze</option>
                                    <option value="prospective">Prospective</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Select Action</label>
                                <select class="form-select" id="partnerAction">
                                    <option value="">Choose action...</option>
                                    <option value="upgrade_gold">Upgrade to Gold</option>
                                    <option value="set_silver">Set to Silver</option>
                                    <option value="set_bronze">Set to Bronze</option>
                                    <option value="downgrade_prospective">Downgrade to Prospective</option>
                                </select>
                            </div>
                            <button class="btn btn-success" onclick="applyPartnerBulkAction()">
                                <i class="fas fa-check"></i> Apply Action
                            </button>
                            <p class="text-muted mt-2 mb-0" id="partnerCount">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Trail Tab -->
        <div class="tab-pane fade" id="audit-trail" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Activity Logs</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="auditSearch" placeholder="Search audit logs...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Action</th>
                                    <th>User</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogsBody">
                                <tr>
                                    <td colspan="4" class="text-center">Loading audit logs...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination justify-content-center" id="auditPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- User Management Tab -->
        <div class="tab-pane fade" id="user-mgmt" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users-cog"></i> User Management</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userSearch" placeholder="Search users by username or email..." onkeyup="searchUsers()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Staff</th>
                                    <th>Active</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Exports Tab -->
        <div class="tab-pane fade" id="exports" role="tabpanel">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-user-graduate"></i> Export Alumni</h5>
                            <p class="card-text">Download all alumni data as CSV</p>
                            <button class="btn btn-primary" onclick="exportData('alumni')">
                                <i class="fas fa-download"></i> Export Alumni CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-building"></i> Export Partners</h5>
                            <p class="card-text">Download all partner data as CSV</p>
                            <button class="btn btn-success" onclick="exportData('partners')">
                                <i class="fas fa-download"></i> Export Partners CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-handshake"></i> Export Engagements</h5>
                            <p class="card-text">Download all engagement data as CSV</p>
                            <button class="btn btn-info text-white" onclick="exportData('engagements')">
                                <i class="fas fa-download"></i> Export Engagements CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = '';
let currentUser = null;

// Check admin access
async function checkAdminAccess() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        window.location.href = '/login/';
        return;
    }

    try {
        const response = await fetch('/auth/user/', {
            headers: {
                'Authorization': `Token ${token}`
            },
            credentials: 'omit'
        });

        if (response.ok) {
            currentUser = await response.json();
            if (!currentUser.is_staff && !currentUser.is_superuser) {
                alert('Access denied. Admin privileges required.');
                window.location.href = '/dashboard/';
                return;
            }
            loadDashboardData();
        } else {
            window.location.href = '/login/';
        }
    } catch (error) {
        console.error('Error:', error);
        window.location.href = '/login/';
    }
}

// Load dashboard statistics
async function loadDashboardData() {
    const token = localStorage.getItem('authToken');
    
    try {
        // Load counts
        const [alumniRes, partnerRes, engagementRes, userRes] = await Promise.all([
            fetch('/api/alumni/', { headers: { 'Authorization': `Token ${token}` }, credentials: 'omit' }),
            fetch('/api/partners/', { headers: { 'Authorization': `Token ${token}` }, credentials: 'omit' }),
            fetch('/api/engagements/', { headers: { 'Authorization': `Token ${token}` }, credentials: 'omit' }),
            fetch('/api/admin/users/', { headers: { 'Authorization': `Token ${token}` }, credentials: 'omit' })
        ]);

        const alumni = await alumniRes.json();
        const partners = await partnerRes.json();
        const engagements = await engagementRes.json();
        const users = await userRes.json();

        document.getElementById('totalAlumni').textContent = alumni.length || 0;
        document.getElementById('totalPartners').textContent = partners.length || 0;
        document.getElementById('totalEngagements').textContent = engagements.length || 0;
        document.getElementById('totalUsers').textContent = users.length || 0;

        updateBulkOperationCounts(alumni, partners);
        loadAuditLogs();
        loadUsers();
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Update bulk operation counts
function updateBulkOperationCounts(alumni, partners) {
    document.getElementById('alumniCount').textContent = `${alumni.length} alumni in database`;
    document.getElementById('partnerCount').textContent = `${partners.length} partners in database`;
}

// Apply alumni bulk action
async function applyAlumniBulkAction() {
    const statusFilter = document.getElementById('alumniStatusFilter').value;
    const action = document.getElementById('alumniAction').value;
    
    if (!action) {
        alert('Please select an action');
        return;
    }

    if (!confirm(`Are you sure you want to apply this action to ${statusFilter || 'all'} alumni?`)) {
        return;
    }

    const token = localStorage.getItem('authToken');
    try {
        const response = await fetch('/api/admin/alumni/bulk-action/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'omit',
            body: JSON.stringify({
                status_filter: statusFilter,
                action: action
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Success! ${result.updated} alumni updated.`);
            loadDashboardData();
        } else {
            alert('Error applying bulk action');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error applying bulk action');
    }
}

// Apply partner bulk action
async function applyPartnerBulkAction() {
    const levelFilter = document.getElementById('partnerLevelFilter').value;
    const action = document.getElementById('partnerAction').value;
    
    if (!action) {
        alert('Please select an action');
        return;
    }

    if (!confirm(`Are you sure you want to apply this action to ${levelFilter || 'all'} partners?`)) {
        return;
    }

    const token = localStorage.getItem('authToken');
    try {
        const response = await fetch('/api/admin/partners/bulk-action/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'omit',
            body: JSON.stringify({
                level_filter: levelFilter,
                action: action
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Success! ${result.updated} partners updated.`);
            loadDashboardData();
        } else {
            alert('Error applying bulk action');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error applying bulk action');
    }
}

// Load audit logs
async function loadAuditLogs() {
    const token = localStorage.getItem('authToken');
    try {
        const response = await fetch('/api/admin/audit-logs/', {
            headers: {
                'Authorization': `Token ${token}`
            },
            credentials: 'omit'
        });

        if (response.ok) {
            const logs = await response.json();
            displayAuditLogs(logs);
        }
    } catch (error) {
        console.error('Error loading audit logs:', error);
        document.getElementById('auditLogsBody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading audit logs</td></tr>';
    }
}

// Display audit logs
function displayAuditLogs(logs) {
    const tbody = document.getElementById('auditLogsBody');
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No audit logs found</td></tr>';
        return;
    }

    tbody.innerHTML = logs.slice(0, 50).map(log => `
        <tr>
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td><strong>${log.title}</strong></td>
            <td>${log.generated_by_username || 'System'}</td>
            <td><small>${log.description}</small></td>
        </tr>
    `).join('');
}

// Load users
async function loadUsers() {
    const token = localStorage.getItem('authToken');
    try {
        const response = await fetch('/api/admin/users/', {
            headers: {
                'Authorization': `Token ${token}`
            },
            credentials: 'omit'
        });

        if (response.ok) {
            const users = await response.json();
            displayUsers(users);
        }
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading users</td></tr>';
    }
}

// Display users
function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.username}</td>
            <td>${user.email || '-'}</td>
            <td>${user.is_staff ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
            <td>${user.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>'}</td>
            <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
            <td>
                <button class="btn btn-sm ${user.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                    ${user.is_active ? 'Deactivate' : 'Activate'}
                </button>
            </td>
        </tr>
    `).join('');
}

// Search users
function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

// Toggle user status
async function toggleUserStatus(userId, currentStatus) {
    if (!confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this user?`)) {
        return;
    }

    const token = localStorage.getItem('authToken');
    try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'omit'
        });

        if (response.ok) {
            alert('User status updated successfully');
            loadUsers();
        } else {
            alert('Error updating user status');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating user status');
    }
}

// Export data
async function exportData(type) {
    const token = localStorage.getItem('authToken');
    try {
        const response = await fetch(`/api/admin/export/${type}/`, {
            headers: {
                'Authorization': `Token ${token}`
            },
            credentials: 'omit'
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('Error exporting data');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error exporting data');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', checkAdminAccess);
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.card-header {
    font-weight: 600;
}

.table th {
    background-color: #f8f9fa;
}

.nav-tabs .nav-link {
    color: #495057;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}

#auditLogsBody small {
    color: #6c757d;
}
</style>
{% endblock %}
