{% extends "base.html" %}

{% block title %}Create Alumni Profile - Alumni Partner Connect{% endblock %}

{% block content %}
<section class="hero" style="padding: 40px 0;">
    <div class="container">
        <h1>Create Alumni Profile</h1>
        <p class="lead">Complete your alumni profile after registering your account</p>
    </div>
</section>

<section class="api-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 mx-auto">
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <h2 class="card-title text-center mb-4">Alumni Profile</h2>

                        <form id="profileForm" onsubmit="handleProfileCreate(event)">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" name="first_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" name="last_name" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="degree" class="form-label">Degree *</label>
                                    <select class="form-select" id="degree" name="degree" required>
                                        <option value="">Select degree</option>
                                        <option value="BS">BS</option>
                                        <option value="BA">BA</option>
                                        <option value="MS">MS</option>
                                        <option value="MA">MA</option>
                                        <option value="PhD">PhD</option>
                                        <option value="Other">Other (Specify)</option>
                                    </select>
                                    <input type="text" class="form-control mt-2 d-none" id="degreeOther" placeholder="Enter your program">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="fieldOfStudy" class="form-label">Field of Study *</label>
                                    <select class="form-select" id="fieldOfStudy" name="field_of_study" required>
                                        <option value="">Select field of study</option>
                                        <option value="Civil Engineering">Civil Engineering</option>
                                        <option value="Computer Engineering">Computer Engineering</option>
                                        <option value="Environmental and Sanitary Engineering">Environmental and Sanitary Engineering</option>
                                        <option value="Electronics Engineering">Electronics Engineering</option>
                                        <option value="Electrical Engineering">Electrical Engineering</option>
                                        <option value="Mechanical Engineering">Mechanical Engineering</option>
                                        <option value="Other">Other (Specify)</option>
                                    </select>
                                    <input type="text" class="form-control mt-2 d-none" id="fieldOfStudyOther" placeholder="Enter your field of study">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="graduationYear" class="form-label">Graduation Year *</label>
                                <input type="number" class="form-control" id="graduationYear" name="graduation_year" required min="1950" max="2050">
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="linkedIn" class="form-label">LinkedIn URL</label>
                                    <input type="url" class="form-control" id="linkedIn" name="linkedin_url">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="company" class="form-label">Current Company</label>
                                    <input type="text" class="form-control" id="company" name="current_company">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="jobTitle" class="form-label">Job Title</label>
                                    <input type="text" class="form-control" id="jobTitle" name="job_title">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="industry" class="form-label">Industry</label>
                                    <input type="text" class="form-control" id="industry" name="industry">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="lost_contact">Lost Contact</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="bio" class="form-label">Bio</label>
                                <textarea class="form-control" id="bio" name="bio" rows="3"></textarea>
                            </div>

                            <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>
                            <div id="successMessage" class="alert alert-success d-none" role="alert"></div>

                            <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="fas fa-user-check"></i> Create Profile
                            </button>
                        </form>

                        <p class="text-center text-muted">
                            Go back to <a href="/dashboard/">Dashboard</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
if (!localStorage.getItem('authToken')) {
    window.location.href = '/login/';
}

document.getElementById('degree').addEventListener('change', function() {
    const degreeOther = document.getElementById('degreeOther');
    if (this.value === 'Other') {
        degreeOther.classList.remove('d-none');
    } else {
        degreeOther.classList.add('d-none');
        degreeOther.value = '';
    }
});

document.getElementById('fieldOfStudy').addEventListener('change', function() {
    const fieldOther = document.getElementById('fieldOfStudyOther');
    if (this.value === 'Other') {
        fieldOther.classList.remove('d-none');
    } else {
        fieldOther.classList.add('d-none');
        fieldOther.value = '';
    }
});

async function prefillUser() {
    const token = localStorage.getItem('authToken');
    if (!token) return;

    try {
        const response = await fetch('/auth/user/', {
            headers: { 'Authorization': 'Token ' + token }
        });
        if (!response.ok) return;
        const data = await response.json();
        const user = data.user;

        if (user) {
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('email').value = user.email || '';
        }
    } catch (e) {
        // ignore
    }
}

prefillUser();

async function handleProfileCreate(event) {
    event.preventDefault();

    const degreeSelect = document.getElementById('degree');
    const degreeOther = document.getElementById('degreeOther');
    const fieldSelect = document.getElementById('fieldOfStudy');
    const fieldOther = document.getElementById('fieldOfStudyOther');

    if (degreeSelect.value === 'Other') {
        const customProgram = (degreeOther.value || '').trim();
        if (!customProgram) {
            document.getElementById('errorMessage').textContent = 'Please specify your program for Other.';
            document.getElementById('errorMessage').classList.remove('d-none');
            return;
        }
        const customOption = new Option(customProgram, customProgram, true, true);
        degreeSelect.add(customOption);
        degreeSelect.value = customProgram;
    }

    if (fieldSelect.value === 'Other') {
        const customField = (fieldOther.value || '').trim();
        if (!customField) {
            document.getElementById('errorMessage').textContent = 'Please specify your field of study for Other.';
            document.getElementById('errorMessage').classList.remove('d-none');
            return;
        }
        const customFieldOption = new Option(customField, customField, true, true);
        fieldSelect.add(customFieldOption);
        fieldSelect.value = customField;
    }

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    const token = localStorage.getItem('authToken');

    if (!token) {
        document.getElementById('errorMessage').textContent = 'Please login first.';
        document.getElementById('errorMessage').classList.remove('d-none');
        return;
    }

    document.getElementById('errorMessage').classList.add('d-none');
    document.getElementById('successMessage').classList.add('d-none');

    try {
        const response = await fetch('/api/my-profile/', {
            method: 'POST',
            credentials: 'omit',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + token
            },
            body: JSON.stringify(data)
        });

        const responseText = await response.text();
        let result = {};
        try {
            result = responseText ? JSON.parse(responseText) : {};
        } catch (e) {
            result = {};
        }

        if (response.ok) {
            document.getElementById('successMessage').textContent = 'Profile created successfully! Redirecting to dashboard...';
            document.getElementById('successMessage').classList.remove('d-none');
            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 1500);
        } else {
            const errors = Object.entries(result).map(([key, value]) =>
                `${key}: ${Array.isArray(value) ? value.join(', ') : value}`
            ).join('\n');
            const fallback = responseText && responseText.trim() ? responseText : 'Profile creation failed. Please try again.';
            document.getElementById('errorMessage').textContent = errors || fallback;
            document.getElementById('errorMessage').classList.remove('d-none');
        }
    } catch (error) {
        document.getElementById('errorMessage').textContent = 'An error occurred. Please try again.';
        document.getElementById('errorMessage').classList.remove('d-none');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
